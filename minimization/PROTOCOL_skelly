#!/bin/bash
#SBATCH --time=2:00:00
#SBATCH --partition=(PART) --qos=(QOS)
#SBATCH --tasks=8
#SBATCH --output=(REV)slurm.out --open-mode=append
#SBATCH --mail-user=(WHOAMI)@stanford.edu --mail-type=ALL
#SBATCH --job-name=(NAM)_min
#
#=====================================================================
#                            PROTOCOL(REV)
#=====================================================================
# GOAL   : Minimize the system 
# INPUTS : 
# OUTPUT : 
# PROJECT: (NAM)
# PATH   : (DIR)
# DATE   : (NOW)
#=====================================================================
#

# Protocol revision number
rev=(REV)

# input files
prmtop="(PRMTOP)"
inpcrd="(INPCRD)"
ref="(REF)"

# Directory with input files
inpdir="(INP)"
cd "$inpdir"

# Exit if any command fails
set -e

# Load necessary modules
date
source "/share/PI/rondror/software/amber_dev/setup_amber.sh"

# Minimize holding the protein really fixed and the lipid mostly fixed
echo "First minimization...of $SLURM_JOB_NAME"
$MPI_HOME/bin/mpirun -np 8 --bind-to socket $AMBERHOME/bin/pmemd.MPI -O -i "$inpdir/01_min.mdin" \
                                                    -o "min1.mdout" -p "$prmtop" \
                                                    -c "$inpcrd" -r "min1.rst" -ref "$ref"
chmod a-w "min1"*

# Minimize with slightly weaker restraints
echo "Second minimization...of $SLURM_JOB_NAME"
$MPI_HOME/bin/mpirun -np 8 --bind-to socket  $AMBERHOME/bin/pmemd.MPI -O -i "$inpdir/02_min.mdin" \
                                                    -o "min2.mdout" -p "$prmtop" \
                                                    -c "min1.rst" -r "min2.rst" -ref "$ref"
chmod a-w "min2"*

# Minimize with restraint weight 1 on non solvent non   
echo "Third minimization...of $SLURM_JOB_NAME"
$MPI_HOME/bin/mpirun -np 8 --bind-to socket $AMBERHOME/bin/pmemd.MPI -O -i "$inpdir/03_min.mdin" \
                                                    -o "min3.mdout" -p "$prmtop" \
                                                    -c "min2.rst" -r "min3.rst" -ref "$ref"
chmod a-w "min3"*

echo "Done with $SLURM_JOB_NAME"
date
